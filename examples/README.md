How to demo
============

## Run OPA in server mode

1. Check the [latest OPA release](https://github.com/open-policy-agent/opa/releases) and download it.
2. Put the binary file in the `PATH` of your system
3. Allow its execution with something like
    ```bash
    chmod 755 ~/opa
    ```
3. Run opa in server mode with the sample policies:

    ```bash
    cd examples
    opa run -s data.json app.rego
    ```
    
In this folder (examples) you will find a simple ``app.py`` file that contains endpoints to test how you can see some
data using OPA. For commodity purposes the user id will be passed in the request using the header *Authorization*.

> Run the app.py file with your IDE. It will run in http://localhost:5000


## Try out some http requests

- Check the home page
    curl http://localhost:5000

- Check list of users using a non admin user: Denied
  ```bash
    curl -X GET \
      http://localhost:5000/list \
      -H 'Authorization: paul' \
      -H 'Content-Type: application/json'
    ```
    
- Check list of users using an admin user: Granted
  ```bash
    curl -X GET \
      http://localhost:5000/list \
      -H 'Authorization: eliux' \
      -H 'Content-Type: application/json'
    ```

- Add a new user (steve) data using an admin user: Granted
    ```bash 
    curl -X POST \
      http://localhost:5000/data/steve \
      -H 'Authorization: steve' \
      -H 'Content-Type: application/json' \
      -d '{
        "fullname": "Steve Perez",
        "city": "New York",
        "salary": 3400,
        "biography": "Studied in harvard. Leaves in Miami, Florida"
    }'
    ```
 
 - Get new user's data using another non admin user: Denied
   ```bash
    curl -X GET \
      http://localhost:5000/data/steve \
      -H 'Authorization: paul' \
      -H 'Content-Type: application/json'
    ```
 
 - Get new user's data using an admin user: Granted
   ```bash
    curl -X GET \
      http://localhost:5000/data/steve \
      -H 'Authorization: eliux' \
      -H 'Content-Type: application/json'
    ``` 
    
 - Get new user's data using same user, yet not a admin one: Granted
   ```bash
    curl -X GET \
      http://localhost:5000/data/steve \
      -H 'Authorization: steve' \
      -H 'Content-Type: application/json'
    ```
    
- Try to delete a user using the same user but not an admin one: Denied
    ```bash
    curl -X DELETE \
      http://localhost:5000/data/steve \
      -H 'Authorization: steve' \
      -H 'Content-Type: application/json'
    ```
    
- Try to delete a user using an admin user: Granted
    ```bash
    curl -X DELETE \
      http://localhost:5000/data/steve \
      -H 'Authorization: eliux' \
      -H 'Content-Type: application/json'
    ```
    
## Try Policy Enforcement Point on functions
When you try to enforce policies beyond the endpoint layer you may not evaluate policies just depending on the data 
related to the user request, but probably you need to be aware of the parameters of a function. E.g.

 
### Problem
1. We want to create a policy for logging data in a remote server, so that call will be encapsulated in a log dedicated
 function called `log_remotely` that will be used in multiple endpoints.
2. The log function will be allow to log info only information generated by an admin user or if the information contains
information 

### Solution
1. As the function will be used across multiple endpoints we cannot base our policy for such function will be independent
of the requests. In such cases its better to use a [Policy Enforcement Point](https://en.wikipedia.org/wiki/Attribute-based_access_control#Architecture)
to enforce a distinct group of policies in that function.
2. A new OPA package called `logging` will be created to enforce this particular set of policies.

You can see the implementation of the PEP in Python in [utils.py](utils.py) and the policies in [logging.rego](logging.rego).

Check the [logging_test.rego](logging_test.rego) to check the valid and invalid queries.
